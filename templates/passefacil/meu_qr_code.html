<!-- templates/passefacil/meu_qr_code.html -->
{% extends 'base.html' %}
{% load static %}

{% block extra_styles %}
{{ block.super }}
<style>
    .qr-code-container {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        max-width: 500px;
        margin: 2rem auto;
        text-align: center;
    }

    .qr-code-header {
        margin-bottom: 1.5rem;
    }

    .qr-code-header h2 {
        color: #2c3e50;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .qr-code-header p {
        color: #7f8c8d;
        font-size: 1.1rem;
    }

    .btn-toggle-qr {
        background: linear-gradient(135deg, #3498db, #2980b9);
        border: none;
        border-radius: 50px;
        padding: 0.8rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(52, 152, 219, 0.3);
        margin: 1rem 0;
    }

    .btn-toggle-qr:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(52, 152, 219, 0.4);
    }

    .btn-toggle-qr:active {
        transform: translateY(0);
    }

    #qrCodeContainer {
        margin: 2rem 0;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 8px;
        display: none;
        animation: fadeIn 0.5s ease-in-out;
        position: relative;
        min-height: 300px;
    }

    .loading-overlay {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        z-index: 10;
        border-radius: 8px;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    #qrCodeImage {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        background: white;
    }

    .qr-code-info {
        margin-top: 1.5rem;
        padding: 1rem;
        background: #e8f4fd;
        border-radius: 6px;
        border-left: 4px solid #3498db;
    }

    .qr-code-info p {
        margin: 0;
        color: #2980b9;
        font-size: 1.05rem;
    }

    .qr-code-info strong {
        font-weight: 600;
    }

    .qr-code-footer {
        margin-top: 2rem;
        color: #7f8c8d;
        font-size: 0.9rem;
    }

    .qr-code-footer i {
        color: #e74c3c;
        margin-right: 5px;
    }

    /* Responsive adjustments */
    @media (max-width: 576px) {
        .qr-code-container {
            margin: 1rem;
            padding: 1.5rem 1rem;
        }
        
        .btn-toggle-qr {
            width: 100%;
            padding: 0.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="qr-code-container">
        <div class="qr-code-header">
            <h2>Meu Passe Fácil</h2>
            <p>Mostre este código para validação em qualquer ponto de controle</p>
        </div>

        <button id="toggleQrCode" class="btn btn-toggle-qr">
            <i class="fas fa-qrcode me-2"></i> Mostrar QR Code
        </button>

        <div class="qr-code-placeholder" id="qrCodeContainer">
            <div id="loadingOverlay" class="loading-overlay">
                <div class="spinner"></div>
                <p>Gerando seu QR Code...</p>
            </div>
            <img id="qrCodeImage" src="" alt="Seu QR Code">
            <div class="qr-code-info">
                <p><strong>Última atualização:</strong> <span id="lastUpdated">Agora mesmo</span></p>
                <p><strong>Status:</strong> <span id="qrStatus">Pronto para uso</span></p>
            </div>
        </div>

        <div class="qr-code-footer">
            <i class="fas fa-info-circle"></i>
            Seu código é único e pessoal. Não compartilhe com terceiros.
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleButton = document.getElementById('toggleQrCode');
    const container = document.getElementById('qrCodeContainer');
    const qrImage = document.getElementById('qrCodeImage');
    const qrCodeUrl = "{% url 'passefacil:gerar_qr_code_dinamico' %}";
    
    console.log('Script carregado');
    
    // Adiciona um timestamp para evitar cache
    function getQrCodeUrl() {
        return `${qrCodeUrl}?t=${new Date().getTime()}`;
    }
    
    // Inicialmente esconde o container do QR Code
    container.style.display = 'none';
    
    // Função para mostrar o loading
    function showLoading() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        const qrStatus = document.getElementById('qrStatus');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
            qrStatus.textContent = 'Gerando novo código...';
            qrStatus.style.color = '#e67e22';
        }
    }
    
    // Função para esconder o loading
    function hideLoading() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        const qrStatus = document.getElementById('qrStatus');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
            qrStatus.textContent = 'Pronto para uso';
            qrStatus.style.color = '#27ae60';
        }
    }
    
    // Configura o evento de clique no botão
    toggleButton.addEventListener('click', function() {
        console.log('Botão clicado');
        
        if (container.style.display === 'none') {
            console.log('Mostrando QR Code');
            
            // Mostra o loading
            showLoading();
            
            // Atualiza a URL com um timestamp para evitar cache
            const timestamp = new Date().getTime();
            qrImage.src = getQrCodeUrl() + '&t=' + timestamp;
            
            container.style.display = 'block';
            toggleButton.innerHTML = '<i class="fas fa-sync-alt me-2"></i> Atualizar QR Code';
            
            // Atualiza a data/hora da última atualização
            const now = new Date();
            document.getElementById('lastUpdated').textContent = 
                `Hoje às ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            // Quando a imagem carregar
            qrImage.onload = function() {
                console.log('QR Code carregado com sucesso!');
                // Esconde o loading
                hideLoading();
                
                // Adiciona uma classe de animação suave
                qrImage.style.opacity = '0';
                setTimeout(() => {
                    qrImage.style.transition = 'opacity 0.3s ease-in-out';
                    qrImage.style.opacity = '1';
                }, 100);
                
                // Mostra notificação de sucesso
                const event = new CustomEvent('qrCodeGenerated', { detail: { success: true } });
                document.dispatchEvent(event);
            };
            
            // Tratamento de erro
            qrImage.onerror = function(error) {
                console.error('Erro ao carregar o QR Code:', error);
                hideLoading();
                
                const qrStatus = document.getElementById('qrStatus');
                qrStatus.textContent = 'Erro ao gerar o código';
                qrStatus.style.color = '#e74c3c';
                
                qrImage.alt = 'Erro ao carregar o QR Code';
                
                // Mostra notificação de erro
                const event = new CustomEvent('qrCodeGenerated', { detail: { success: false, error: error } });
                document.dispatchEvent(event);
                
                // Tenta recarregar após 2 segundos
                setTimeout(() => {
                    showLoading();
                    qrImage.src = getQrCodeUrl() + '&t=' + new Date().getTime();
                }, 2000);
            };
            
        } else {
            console.log('Escondendo QR Code');
            container.style.display = 'none';
            toggleButton.innerHTML = '<i class="fas fa-qrcode me-2"></i> Mostrar QR Code';
        }
    });
    
    // Adiciona um listener para o evento de notificação de validação
    document.addEventListener('qrCodeValidated', function(event) {
        const { valid, timestamp, location } = event.detail;
        const statusElement = document.getElementById('qrStatus');
        
        if (valid) {
            statusElement.textContent = `Validado em ${new Date(timestamp).toLocaleString()}`;
            statusElement.style.color = '#27ae60';
            
            // Mostra uma notificação toast
            showToast('Seu código foi validado com sucesso!', 'success');
        } else {
            statusElement.textContent = 'Tentativa de validação inválida';
            statusElement.style.color = '#e74c3c';
            
            // Mostra uma notificação de erro
            showToast('Tentativa de validação inválida detectada', 'error');
        }
        
        // Atualiza a lista de validações recentes
        updateRecentValidations();
    });
    
    // Função para mostrar notificações toast
    function showToast(message, type = 'info') {
        // Verifica se já existe um container de notificações
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.style.position = 'fixed';
            container.style.top = '20px';
            container.style.right = '20px';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }
        
        // Cria o elemento da notificação
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.style.padding = '12px 20px';
        toast.style.marginBottom = '10px';
        toast.style.borderRadius = '4px';
        toast.style.color = 'white';
        toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
        toast.style.transform = 'translateX(120%)';
        toast.style.transition = 'transform 0.3s ease-in-out';
        
        // Define a cor de fundo com base no tipo
        const colors = {
            'success': '#27ae60',
            'error': '#e74c3c',
            'info': '#3498db',
            'warning': '#f39c12'
        };
        toast.style.backgroundColor = colors[type] || colors['info'];
        
        // Adiciona o ícone
        const icons = {
            'success': '✓',
            'error': '✕',
            'info': 'ℹ',
            'warning': '⚠'
        };
        
        toast.innerHTML = `
            <span style="margin-right: 10px; font-weight: bold;">${icons[type] || ''}</span>
            <span>${message}</span>
        `;
        
        // Adiciona a notificação ao container
        container.prepend(toast);
        
        // Anima a entrada
        setTimeout(() => {
            toast.style.transform = 'translateX(0)';
        }, 10);
        
        // Remove a notificação após 5 segundos
        setTimeout(() => {
            toast.style.transform = 'translateX(120%)';
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 5000);
    }
    
    // Função para atualizar a lista de validações recentes
    function updateRecentValidations() {
        // Aqui você pode adicionar uma chamada AJAX para buscar as validações mais recentes
        // e atualizar a seção de histórico na página
        console.log('Atualizando histórico de validações...');
    }
    
    // Exemplo de como disparar um evento de validação (para teste)
    // Descomente para testar
    /*
    setTimeout(() => {
        const event = new CustomEvent('qrCodeValidated', {
            detail: {
                valid: true,
                timestamp: new Date().toISOString(),
                location: 'Portaria Principal'
            }
        });
        document.dispatchEvent(event);
    }, 3000);
    */
});

// Carrega o script de notificações em tempo real
const script = document.createElement('script');
script.src = '{% static 'js/qr-code-notifications.js' %}';
document.head.appendChild(script);
</script>
{% endblock %}