<!-- templates/passefacil/meu_qr_code.html -->
{% extends 'base.html' %}
{% load static %}

{% block extra_styles %}
{{ block.super }}
<style>
    .qr-code-container {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        max-width: 500px;
        margin: 2rem auto;
        text-align: center;
    }

    .qr-code-header {
        margin-bottom: 1.5rem;
    }

    .qr-code-header h2 {
        color: #2c3e50;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .qr-code-header p {
        color: #7f8c8d;
        font-size: 1.1rem;
    }

    .btn-toggle-qr {
        background: linear-gradient(135deg, #3498db, #2980b9);
        border: none;
        border-radius: 50px;
        padding: 0.8rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(52, 152, 219, 0.3);
        margin: 1rem 0;
    }

    .btn-toggle-qr:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(52, 152, 219, 0.4);
    }

    .btn-toggle-qr:active {
        transform: translateY(0);
    }

    #qrCodeContainer {
        margin: 2rem 0;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 8px;
        display: none;
        animation: fadeIn 0.5s ease-in-out;
    }

    #qrCodeImage {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        background: white;
    }

    .qr-code-info {
        margin-top: 1.5rem;
        padding: 1rem;
        background: #e8f4fd;
        border-radius: 6px;
        border-left: 4px solid #3498db;
    }

    .qr-code-info p {
        margin: 0;
        color: #2980b9;
        font-size: 1.05rem;
    }

    .qr-code-info strong {
        font-weight: 600;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .qr-code-footer {
        margin-top: 2rem;
        color: #7f8c8d;
        font-size: 0.9rem;
    }

    .qr-code-footer i {
        color: #e74c3c;
        margin-right: 5px;
    }

    /* Responsive adjustments */
    @media (max-width: 576px) {
        .qr-code-container {
            margin: 1rem;
            padding: 1.5rem 1rem;
        }
        
        .btn-toggle-qr {
            width: 100%;
            padding: 0.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="qr-code-container">
        <div class="qr-code-header">
            <h2>Meu Passe Fácil</h2>
            <p>Mostre este código para validação em qualquer ponto de controle</p>
        </div>

        <button id="toggleQrCode" class="btn btn-toggle-qr">
            <i class="fas fa-qrcode me-2"></i> Mostrar QR Code
        </button>

        <div class="qr-code-placeholder" id="qrCodeContainer">
            <img id="qrCodeImage" src="" alt="QR Code de Validação" style="display: none; max-width: 100%;">
            <p id="qrCodeStatus" class="text-muted">Clique no botão abaixo para exibir seu QR Code</p>
            <!-- Debug info -->
            <div id="debugInfo" style="display: none; margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-family: monospace;">
                <p><strong>Debug Info:</strong></p>
                <p>ID do Usuário: {{ user.id }}</p>
                <p>Nome: {{ user.get_full_name|default:user.username }}</p>
                <p>Código do Passe: <span id="codigoPasse">{{ request.user.passefacil.codigo }}</span></p>
                <button onclick="copyToClipboard('{{ request.user.passefacil.codigo }}')" class="btn btn-sm btn-outline-secondary mt-2">
                    <i class="fas fa-copy"></i> Copiar Código
                </button>
            </div>
        </div>

        <div class="qr-code-footer">
            <i class="fas fa-info-circle"></i>
            Seu código é único e pessoal. Não compartilhe com terceiros.
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleButton = document.getElementById('toggleQrCode');
    const container = document.getElementById('qrCodeContainer');
    const qrImage = document.getElementById('qrCodeImage');
    const qrCodeUrl = "{% url 'passefacil:gerar_qr_code_dinamico' %}";
    
    console.log('Script carregado');
    
    // Adiciona um timestamp para evitar cache
    function getQrCodeUrl() {
        return `${qrCodeUrl}?t=${new Date().getTime()}`;
    }
    
    // Inicialmente esconde o container do QR Code
    container.style.display = 'none';
    
    toggleButton.addEventListener('click', function() {
        console.log('Botão clicado');
        
        if (container.style.display === 'none' || container.style.display === '') {
            console.log('Mostrando QR Code...');
            
            // Sempre carrega uma nova imagem para evitar problemas de cache
            qrImage.src = getQrCodeUrl();
            
            // Mostra o container imediatamente
            container.style.display = 'block';
            toggleButton.innerHTML = '<i class="fas fa-sync-alt fa-spin me-2"></i> Carregando...';
            
            // Quando a imagem carregar
            qrImage.onload = function() {
                console.log('QR Code carregado com sucesso');
                toggleButton.innerHTML = '<i class="fas fa-eye-slash me-2"></i> Ocultar QR Code';
                document.getElementById('qrCodeStatus').style.display = 'none';
                qrImage.style.display = 'block';
                document.getElementById('debugInfo').style.display = 'block';
                
                // Log para depuração
                console.log('Código do passe:', document.getElementById('codigoPasse').textContent);
            };
            
            // Tratamento de erro
            qrImage.onerror = function(error) {
                console.error('Erro ao carregar o QR Code:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erro ao carregar o QR Code. <button class="btn btn-sm btn-outline-primary ms-2" onclick="location.reload()">Tentar novamente</button>
                    </div>
                `;
                toggleButton.innerHTML = '<i class="fas fa-sync-alt me-2"></i> Tentar novamente';
            };
            
        } else {
            console.log('Escondendo QR Code');
            container.style.display = 'none';
            toggleButton.innerHTML = '<i class="fas fa-qrcode me-2"></i> Mostrar QR Code';
        }
    });
});
</script>
{% endblock %}