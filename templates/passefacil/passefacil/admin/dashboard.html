<!-- templates/admin/passefacil/dashboard.html -->
{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block content_title %}
<h1>Painel de Controle Passe Fácil</h1>
{% endblock %}

{% block result_list %}
<div class="dashboard-container">
    <!-- Estatísticas -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Validações Hoje</h3>
            <p>{{ total_validacoes_hoje }}</p>
        </div>
        <div class="stat-card valid">
            <h3>Válidas</h3>
            <p>{{ validacoes_validas }}</p>
        </div>
        <div class="stat-card invalid">
            <h3>Inválidas</h3>
            <p>{{ validacoes_invalidas }}</p>
        </div>
    </div>

    <!-- Scanner QR Code -->
    <div class="scanner-section">
        <h2>Validar QR Code</h2>
        <button id="startScanner" class="btn btn-primary">
            <i class="fas fa-camera me-2"></i> Ativar Câmera
        </button>
        <div id="scanner-container" style="display: none; margin: 20px 0; text-align: center;">
            <div id="reader" style="width: 300px; margin: 0 auto; border: 2px solid #ddd; border-radius: 8px; overflow: hidden;"></div>
            <div id="scanner-result" class="mt-3 p-3" style="min-height: 50px; border-radius: 4px; background-color: #f8f9fa;">
                <p class="text-muted mb-0">Aponte a câmera para o QR Code</p>
            </div>
            <div class="mt-3">
                <button id="stopScanner" class="btn btn-outline-danger" style="display: none;">
                    <i class="fas fa-stop me-2"></i> Parar Scanner
                </button>
            </div>
        </div>
    </div>

    <!-- Últimas Validações -->
    <div class="recent-validations">
        <h2>Últimas Validações</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Usuário</th>
                    <th>Código</th>
                    <th>Status</th>
                    <th>Data/Hora</th>
                </tr>
            </thead>
            <tbody>
                {% for validacao in ultimas_validacoes %}
                <tr>
                    <td>{% if validacao.passe_facil and validacao.passe_facil.user %}{{ validacao.passe_facil.user.get_full_name|default:validacao.passe_facil.user.username }}{% else %}Usuário não encontrado{% endif %}</td>
                    <td>{{ validacao.codigo|default:'N/A' }}</td>
                    <td>
                        <span class="badge {% if validacao.valido %}bg-success{% else %}bg-danger{% endif %}">
                            {% if validacao.valido %}Válido{% else %}Inválido{% endif %}
                        </span>
                    </td>
                    <td>{% if validacao.data_validacao %}{{ validacao.data_validacao|date:"d/m/Y H:i" }}{% else %}N/A{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Inclui o HTML5 QR Code Scanner -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
.dashboard-container { padding: 20px; }
.stats-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
    gap: 20px; 
    margin-bottom: 30px; 
}
.stat-card { 
    background: #f8f9fa; 
    padding: 20px; 
    border-radius: 8px; 
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.stat-card h3 { 
    margin: 0 0 10px 0; 
    color: #666; 
    font-size: 1rem; 
}
.stat-card p { 
    margin: 0; 
    font-size: 2rem; 
    font-weight: bold; 
}
.stat-card.valid { border-left: 4px solid #28a745; }
.stat-card.invalid { border-left: 4px solid #dc3545; }
.scanner-section { 
    background: white; 
    padding: 20px; 
    border-radius: 8px; 
    margin-bottom: 30px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
#reader { 
    border: 2px solid #ddd; 
    border-radius: 8px; 
    overflow: hidden; 
    margin: 20px 0; 
}
#scanner-result { 
    text-align: center; 
    padding: 10px; 
    font-weight: bold; 
}
.btn { 
    padding: 8px 16px; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer; 
    font-weight: 500; 
}
.btn-primary { 
    background-color: #0d6efd; 
    color: white; 
}
.btn-primary:hover { 
    background-color: #0b5ed7; 
}
</style>

<script>
let html5QrcodeScanner = null;
const startButton = document.getElementById('startScanner');
const stopButton = document.getElementById('stopScanner');
const container = document.getElementById('scanner-container');
const resultDiv = document.getElementById('scanner-result');

// Função para iniciar o scanner
async function startScanner() {
    try {
        // Mostra o container e os botões
        container.style.display = 'block';
        startButton.style.display = 'none';
        stopButton.style.display = 'inline-block';
        
        // Limpa resultados anteriores
        resultDiv.innerHTML = '<p class="text-muted mb-0">Aguardando leitura do QR Code...</p>';
        resultDiv.style.color = 'inherit';
        
        // Inicializa o scanner
        html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", 
            { 
                fps: 10, 
                qrbox: 250,
                aspectRatio: 1.0
            },
            /* verbose= */ false
        );
        
        // Renderiza o scanner
        html5QrcodeScanner.render(
            // Callback de sucesso
            async (decodedText, decodedResult) => {
                console.log('QR Code lido:', decodedText);
                
                // Mostra mensagem de processamento
                resultDiv.innerHTML = '<div class="text-info"><i class="fas fa-spinner fa-spin me-2"></i> Validando código...</div>';
                
                try {
                    // Envia o código para validação
                    const formData = new FormData();
                    formData.append('codigo', decodedText);
                    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                    
                    const response = await fetch(`/passefacil/api/validar-qr-code/`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: new URLSearchParams(formData)
                    });
                    
                    const data = await response.json();
                    
                    if (data.valido) {
                        // Validação bem-sucedida
                        resultDiv.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Válido!</strong> ${data.mensagem}
                                <div class="mt-2">
                                    <small class="d-block">Usuário: ${data.usuario.nome}</small>
                                    <small class="d-block">Data: ${data.data_validacao}</small>
                                </div>
                            </div>
                        `;
                        
                        // Recarrega a página após 3 segundos para mostrar a validação na lista
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                    } else {
                        // Código inválido
                        let errorMessage = data.erro || 'Código não reconhecido';
                        if (data.detail) {  // Se houver detalhes adicionais do servidor
                            errorMessage = data.detail;
                        }
                        resultDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle me-2"></i>
                                <strong>Inválido!</strong> ${errorMessage}
                                <div class="mt-2">
                                    <small>Data: ${new Date().toLocaleString()}</small>
                                    ${data.codigo ? `<small class="d-block">Código: ${data.codigo}</small>` : ''}
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Erro ao validar QR Code:', error);
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Erro ao validar o código. Tente novamente.
                        </div>
                    `;
                }
            },
            // Callback de erro
            (error) => {
                console.error('Erro no scanner:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erro ao acessar a câmera. Verifique as permissões e tente novamente.
                    </div>
                `;
            }
        );
    } catch (error) {
        console.error('Erro ao iniciar o scanner:', error);
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Não foi possível acessar a câmera. Certifique-se de que você permitiu o acesso à câmera.
            </div>
        `;
        stopScanner();
    }
}

// Função para parar o scanner
function stopScanner() {
    if (html5QrcodeScanner) {
        try {
            html5QrcodeScanner.clear().catch(error => {
                console.error("Falha ao limpar o scanner", error);
            });
            html5QrcodeScanner = null;
        } catch (error) {
            console.error("Erro ao parar o scanner:", error);
        }
    }
    
    // Esconde o container e reseta os botões
    container.style.display = 'none';
    startButton.style.display = 'inline-block';
    stopButton.style.display = 'none';
    
    // Limpa o resultado
    resultDiv.innerHTML = '<p class="text-muted mb-0">Aponte a câmera para o QR Code</p>';
}

// Event listeners
startButton.addEventListener('click', startScanner);
stopButton.addEventListener('click', stopScanner);

// Limpar recursos quando a página for descarregada
window.addEventListener('beforeunload', () => {
    if (html5QrcodeScanner) {
        stopScanner();
    }
});
</script>
{% endblock %}