<!-- templates/admin/passefacil/dashboard.html -->
{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block content_title %}
<h1>Painel de Controle Passe Fácil</h1>
{% endblock %}

{% block result_list %}
<div class="dashboard-container">
    <!-- Estatísticas -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Validações Hoje</h3>
            <p>{{ total_validacoes_hoje }}</p>
        </div>
        <div class="stat-card valid">
            <h3>Válidas</h3>
            <p>{{ validacoes_validas }}</p>
        </div>
        <div class="stat-card invalid">
            <h3>Inválidas</h3>
            <p>{{ validacoes_invalidas }}</p>
        </div>
    </div>

    <!-- Scanner QR Code -->
    <div class="scanner-section">
        <h2>Validar QR Code</h2>
        <button id="startScanner" class="btn btn-primary">Ativar Câmera</button>
        <div id="scanner-container" style="display: none; margin: 20px 0;">
            <div id="reader" style="width: 300px; margin: 0 auto;"></div>
            <div id="scanner-result"></div>
        </div>
    </div>

    <!-- Últimas Validações -->
    <div class="recent-validations">
        <h2>Últimas Validações</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Usuário</th>
                    <th>Código</th>
                    <th>Status</th>
                    <th>Data/Hora</th>
                </tr>
            </thead>
            <tbody>
                {% for validacao in ultimas_validacoes %}
                <tr>
                    <td>{{ validacao.passe_facil.user.get_full_name|default:validacao.passe_facil.user.username }}</td>
                    <td>{{ validacao.codigo }}</td>
                    <td>
                        <span class="badge {% if validacao.valido %}bg-success{% else %}bg-danger{% endif %}">
                            {% if validacao.valido %}Válido{% else %}Inválido{% endif %}
                        </span>
                    </td>
                    <td>{{ validacao.data_validacao|date:"d/m/Y H:i" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Inclui o HTML5 QR Code Scanner -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
.dashboard-container { padding: 20px; }
.stats-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
    gap: 20px; 
    margin-bottom: 30px; 
}
.stat-card { 
    background: #f8f9fa; 
    padding: 20px; 
    border-radius: 8px; 
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.stat-card h3 { 
    margin: 0 0 10px 0; 
    color: #666; 
    font-size: 1rem; 
}
.stat-card p { 
    margin: 0; 
    font-size: 2rem; 
    font-weight: bold; 
}
.stat-card.valid { border-left: 4px solid #28a745; }
.stat-card.invalid { border-left: 4px solid #dc3545; }
.scanner-section { 
    background: white; 
    padding: 20px; 
    border-radius: 8px; 
    margin-bottom: 30px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
#reader { 
    border: 2px solid #ddd; 
    border-radius: 8px; 
    overflow: hidden; 
    margin: 20px 0; 
}
#scanner-result { 
    text-align: center; 
    padding: 10px; 
    font-weight: bold; 
}
.btn { 
    padding: 8px 16px; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer; 
    font-weight: 500; 
}
.btn-primary { 
    background-color: #0d6efd; 
    color: white; 
}
.btn-primary:hover { 
    background-color: #0b5ed7; 
}
</style>

<script>
let html5QrcodeScanner;

document.getElementById('startScanner').addEventListener('click', function() {
    const container = document.getElementById('scanner-container');
    const button = document.getElementById('startScanner');
    
    if (container.style.display === 'none') {
        // Iniciar o scanner
        container.style.display = 'block';
        button.textContent = 'Desativar Câmera';
        
        // Inicializa o scanner
        html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", 
            { 
                fps: 10, 
                qrbox: 250 
            },
            /* verbose= */ false
        );
        
        html5QrcodeScanner.render((decodedText, decodedResult) => {
            // Quando um QR Code for lido
            const resultDiv = document.getElementById('scanner-result');
            resultDiv.innerHTML = `Lendo: ${decodedText}`;
            
            // Aqui você pode adicionar uma chamada AJAX para validar o QR Code
            fetch(`/api/validar-qr-code/?codigo=${encodeURIComponent(decodedText)}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.valido) {
                    resultDiv.innerHTML = `✅ ${data.mensagem}`;
                    resultDiv.style.color = 'green';
                    
                    // Recarrega a página após 1.5 segundos para atualizar a lista
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    resultDiv.innerHTML = `❌ ${data.mensagem}`;
                    resultDiv.style.color = 'red';
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                resultDiv.innerHTML = 'Erro ao validar o QR Code';
                resultDiv.style.color = 'red';
            });
        });
    } else {
        // Parar o scanner
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear().catch(error => {
                console.error("Falha ao limpar o scanner", error);
            });
        }
        container.style.display = 'none';
        button.textContent = 'Ativar Câmera';
    }
});
</script>
{% endblock %}