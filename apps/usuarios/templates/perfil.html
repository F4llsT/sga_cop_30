{% extends 'base.html' %}
{% load static %}

{% block title %}Meu Perfil - COP30{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/perfil.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <header class="page-header">
        <h1>Meu Perfil</h1>
        <p>Gerencie suas informações pessoais e endereço.</p>
    </header>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

        <div class="profile-grid">
            <aside class="profile-sidebar">
                <div class="profile-picture-card">
                    <div class="picture-wrapper">
                        {% if user.perfil.foto_perfil %}
                            <img src="{{ user.perfil.foto_perfil.url }}" alt="Foto de Perfil do Usuário" id="profile-image">
                        {% else %}
                            <img src="" alt="Foto de Perfil do Usuário" id="profile-image" style="display: none;">
                        {% endif %}
                        <div class="default-avatar" id="default-avatar">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <!-- Input customizado para abrir o seletor -->
                        <input type="file" id="image-upload-input" accept="image/*" class="sr-only">
                    </div>
                    <h3>{{ user.nome|default:user.username }}</h3>
                    <p>{{ user.email }}</p>
                    <div class="picture-actions-container">
                        <button class="btn-secondary" id="edit-picture-btn">Editar</button>
                        <div class="picture-actions-menu" id="picture-actions-menu">
                            <button class="action-btn" id="change-picture-btn"><i class="fa-solid fa-pen-to-square"></i> Alterar Foto</button>
                            <button class="action-btn danger" id="remove-picture-btn"><i class="fa-solid fa-trash"></i> Remover Foto</button>
                        </div>
                    </div>
                </div>
            </aside>

        <main class="profile-main">
            <form method="post" enctype="multipart/form-data" id="profile-form" novalidate>
                {% csrf_token %}
                <!-- Campo do formulário para foto (oculto) -->
                <div style="display: none;">
                    {{ profile_form.foto_perfil }}
                </div>
                
                <div class="form-section">
                    <h2>Informações Pessoais</h2>
                    
                    <!-- Nome e Email (do formulário de usuário) -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.nome.label_tag }}
                                {{ form.nome }}
                                {% if form.nome.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.nome.errors|join:", " }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
                                <input type="email" 
                                       class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                                       id="{{ form.email.id_for_label }}" 
                                       name="{{ form.email.name }}" 
                                       value="{{ form.email.value|default:user.email }}" 
                                       required>
                                {% if form.email.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.email.errors|join:", " }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gênero e Data de Nascimento -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ profile_form.genero.label_tag }}
                                {{ profile_form.genero }}
                                {% if profile_form.genero.errors %}
                                    <div class="invalid-feedback">
                                        {{ profile_form.genero.errors|join:", " }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ profile_form.data_nascimento.id_for_label }}">{{ profile_form.data_nascimento.label }}</label>
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control {% if profile_form.data_nascimento.errors %}is-invalid{% endif %}" 
                                           id="{{ profile_form.data_nascimento.id_for_label }}" 
                                           name="{{ profile_form.data_nascimento.name }}" 
                                           value="{% if profile_form.data_nascimento.value %}{{ profile_form.data_nascimento.value|date:'d/m/Y' }}{% endif %}" 
                                           placeholder="DD/MM/AAAA"
                                           maxlength="10"
                                           inputmode="numeric">

                                    {% if profile_form.data_nascimento.errors %}
                                        <div class="invalid-feedback">
                                            {{ profile_form.data_nascimento.errors|join:", " }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Informações de Contato</h2>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="{{ profile_form.telefone.id_for_label }}">{{ profile_form.telefone.label }}</label>
                                <div class="input-group">
                                    <input type="tel" 
                                           class="form-control {% if profile_form.telefone.errors %}is-invalid{% endif %}" 
                                           id="{{ profile_form.telefone.id_for_label }}" 
                                           name="{{ profile_form.telefone.name }}" 
                                           value="{{ profile_form.telefone.value|default:'' }}" 
                                           placeholder="(00) 00000-0000"
                                           maxlength="15"
                                           inputmode="numeric">

                                    {% if profile_form.telefone.errors %}
                                        <div class="invalid-feedback">
                                            {{ profile_form.telefone.errors|join:", " }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Endereço</h2>
                    
                    <!-- CEP, Logradouro e Número -->
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                {{ profile_form.cep.label_tag }}
                                <div class="input-group">
                                    {{ profile_form.cep }}

                                </div>
                                {% if profile_form.cep.errors %}
                                    <div class="invalid-feedback">
                                        {{ profile_form.cep.errors|join:", " }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="form-group">
                                {{ profile_form.logradouro.label_tag }}
                                {{ profile_form.logradouro }}
                                {% if profile_form.logradouro.errors %}
                                    <div class="invalid-feedback">
                                        {{ profile_form.logradouro.errors|join:", " }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                {{ profile_form.numero.label_tag }}
                                {{ profile_form.numero }}
                                {% if profile_form.numero.errors %}
                                    <div class="invalid-feedback">
                                        {{ profile_form.numero.errors|join:", " }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Complemento e Bairro -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ profile_form.complemento.label_tag }}
                                {{ profile_form.complemento }}
                                {% if profile_form.complemento.help_text %}
                                    <small class="form-text text-muted">{{ profile_form.complemento.help_text }}</small>
                                {% endif %}
                                {% if profile_form.complemento.errors %}
                                    <div class="invalid-feedback">
                                        {{ profile_form.complemento.errors|join:", " }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ profile_form.bairro.label_tag }}
                                {{ profile_form.bairro }}
                                {% if profile_form.bairro.errors %}
                                    <div class="invalid-feedback">
                                        {{ profile_form.bairro.errors|join:", " }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cidade e Estado -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                {{ profile_form.cidade.label_tag }}
                                {{ profile_form.cidade }}
                                {% if profile_form.cidade.errors %}
                                    <div class="invalid-feedback">
                                        {{ profile_form.cidade.errors|join:", " }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ profile_form.estado.label_tag }}
                                {{ profile_form.estado }}
                                {% if profile_form.estado.errors %}
                                    <div class="invalid-feedback">
                                        {{ profile_form.estado.errors|join:", " }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="main-actions">
                    <button type="button" class="btn-danger" id="delete-account-btn">
                        <i class="fa-solid fa-trash"></i> Excluir Minha Conta
                    </button>
                    <button type="submit" class="btn btn-primary" id="save-all-btn">
                        <i class="fa-solid fa-save"></i> Salvar Alterações
                    </button>
                </div>
            </form>
        </main>
    </div>
</div>

<!-- Modal de confirmação de exclusão -->
<div class="modal-overlay" id="delete-modal-overlay">
    <div class="modal-content">
        <i class="fa-solid fa-triangle-exclamation modal-icon"></i>
        <h2>Você tem certeza?</h2>
        <p>Esta ação é permanente e não pode ser desfeita. Todos os seus dados serão removidos.</p>
        <div class="modal-actions">
            <button class="btn-secondary" id="cancel-delete-btn">
                <i class="fa-solid fa-xmark"></i> Cancelar
            </button>
            <button class="btn-danger" id="confirm-delete-btn">
                <i class="fa-solid fa-trash"></i> Excluir
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/perfil.js' %}"></script>
{% endblock %}