<!-- usuario_detalhes.html -->
{% extends 'admin_personalizado/baseadmin.html' %}
{% load static %}

{% block title %}Detalhes do Usuário - {{ usuario.get_full_name|default:usuario.username }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin_personalizado/css/passefacilADM.css' %}">
<link rel="stylesheet" href="{% static 'admin_personalizado/css/usuario_detalhes.css' %}">
{% endblock %}

{% block content %}
<div class="passe-facil-container">
    <!-- Cabeçalho -->
    <header class="main-header">
        <div class="header-actions">
            <a href="{% url 'admin_personalizado:listar_usuarios' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
            <h2>Gerenciar Usuário</h2>
            <div>
                <button type="button" class="btn btn-primary" id="btnEditarPerfil">
                    <i class="fas fa-edit"></i> Editar Perfil
                </button>
                <button type="button" class="btn btn-success d-none" id="btnSalvarPerfil">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
                <button type="button" class="btn btn-outline-secondary d-none" id="btnCancelarEdicao">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </header>

    <!-- Seção de Informações do Usuário -->
    <div class="user-detail-container">
        <div class="user-profile-header">
            <div class="user-avatar-large">
                {% if usuario.nome and usuario.nome.strip %}
                    {{ usuario.nome|first|upper }}
                {% elif usuario.email and usuario.email.strip %}
                    {{ usuario.email|first|upper }}
                {% else %}
                    U
                {% endif %}
            </div>
            <div class="user-info">
                <h1>{{ usuario.get_full_name|default:usuario.email }}</h1>
                <div class="user-meta">
                    <span class="user-role">
                        <i class="fas fa-user-tag"></i>
                        {% if usuario.is_superuser %}
                            Administrador
                        {% elif usuario.groups.exists %}
                            {{ usuario.groups.first.name }}
                        {% else %}
                            Usuário
                        {% endif %}
                    </span>
                    <span class="user-status {% if usuario.is_active %}status-active{% else %}status-inactive{% endif %}">
                        <i class="fas fa-circle"></i>
                        {% if usuario.is_active %}Ativo{% else %}Inativo{% endif %}
                    </span>
                </div>
            </div>
        </div>

        <div class="user-details-grid">
            <!-- Informações Básicas -->

                        <div class="detail-card">
                <div class="detail-card-header">
                    <h3><i class="fas fa-info-circle"></i> Informações Básicas</h3>
                </div>
                <div class="detail-card-body">
                    <form id="basicInfoForm" method="post" action="{% url 'admin_personalizado:atualizar_usuario' usuario.id %}">
                        {% csrf_token %}
                        <div class="detail-row view-mode">
                            <span class="detail-label">Nome Completo:</span>
                            <span class="detail-value">{{ usuario.get_full_name|default:"Não informado" }}</span>
                        </div>
                        <div class="detail-row edit-mode d-none">
                            <label class="form-label">Nome Completo</label>
                            <input type="text" name="nome_completo" class="form-control" value="{{ usuario.get_full_name }}">
                        </div>
                        
                        <div class="detail-row view-mode">
                            <span class="detail-label">E-mail:</span>
                            <span class="detail-value">{{ usuario.email }}</span>
                        </div>
                        <div class="detail-row edit-mode d-none">
                            <label class="form-label">E-mail</label>
                            <input type="email" name="email" class="form-control" value="{{ usuario.email }}">
                        </div>
                        
                        <div class="detail-row">
                            <span class="detail-label">Data de Cadastro:</span>
                            <span class="detail-value">{{ usuario.date_joined|date:"d/m/Y H:i" }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Último Acesso:</span>
                            <span class="detail-value">
                                {% if usuario.last_login %}
                                    {{ usuario.last_login|date:"d/m/Y H:i" }}
                                {% else %}
                                    Nunca acessou
                                {% endif %}
                            </span>
                        </div>
                        
                        <div class="detail-row edit-mode d-none">
                            <label class="form-label">Senha (deixe em branco para não alterar)</label>
                            <input type="password" name="nova_senha" class="form-control" placeholder="Nova senha">
                        </div>
                    </form>
                </div>
            </div>


            <div class="detail-card">
                <div class="detail-card-header">
                    <h3><i class="fas fa-user-shield"></i> Gerenciamento de Papel</h3>
                </div>
                <div class="detail-card-body">
                    <form id="roleForm" method="post" action="{% url 'admin_personalizado:alterar_papel' usuario.id %}">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="papel">Papel Atual:</label>
                            <div class="current-role">
                                {% if usuario.is_superuser %}
                                    <span class="badge bg-danger">Superusuário</span>
                                    <p class="text-muted mt-2">Acesso total a todas as áreas e funcionalidades do sistema.</p>
                                {% elif usuario.groups.exists %}
                                    {% with grupo=usuario.groups.first %}
                                        {% if grupo.name == 'Usuário-Gerente' %}
                                            <span class="badge bg-primary">{{ grupo.name }}</span>
                                            <p class="text-muted mt-2">Acesso ao painel administrativo, visualização de todos os usuários. Não pode editar nem excluir contas.</p>
                                        {% elif grupo.name == 'Usuário-Eventos' %}
                                            <span class="badge bg-success">{{ grupo.name }}</span>
                                            <p class="text-muted mt-2">Pode criar e gerenciar eventos no painel de controle.</p>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ grupo.name }}</span>
                                            <p class="text-muted mt-2">Acesso apenas à área pública do sistema.</p>
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    <span class="badge bg-secondary">Usuário Comum</span>
                                    <p class="text-muted mt-2">Acesso apenas à área pública do sistema.</p>
                                {% endif %}
                            </div>
                        </div>

                        {% if request.user.is_superuser or is_gerente %}
                        <div class="form-group mt-4">
                            <label for="novo_papel" class="form-label">Alterar Papel:</label>
                            <select name="novo_papel" id="novo_papel" class="form-select">
                                <option value="">Selecione um papel</option>
                                {% for grupo in papeis_disponiveis %}
                                    <option value="{{ grupo.id }}">{{ grupo.name }}</option>
                                {% endfor %}
                                {% if not usuario.is_superuser %}
                                    <option value="nenhum">Remover todos os papéis</option>
                                {% endif %}
                            </select>
                            <div class="form-text">Selecione um novo papel para o usuário</div>
                        </div>
                        <button type="button" id="btnAlterarPapel" class="btn btn-primary mt-2" 
                                {% if usuario.is_superuser %}disabled{% endif %}>
                            <i class="fas fa-save"></i> Salvar Alterações
                        </button>
                        {% endif %}
                    </form>
                </div>
            </div>
            <!-- Informações Pessoais -->
            <div class="detail-card">
                <div class="detail-card-header">
                    <h3><i class="fas fa-user-circle"></i> Informações Pessoais</h3>
                </div>
                <div class="detail-card-body">
                    <form id="personalInfoForm" method="post" action="{% url 'admin_personalizado:atualizar_usuario' usuario.id %}">
                        {% csrf_token %}
                        <div class="detail-row view-mode">
                            <span class="detail-label">Gênero:</span>
                            <span class="detail-value" id="generoDisplay">
                                {% if usuario.perfil.genero == 'M' %}
                                    Masculino
                                {% elif usuario.perfil.genero == 'F' %}
                                    Feminino
                                {% elif usuario.perfil.genero == 'O' %}
                                    Outro
                                {% else %}
                                    Não informado
                                {% endif %}
                            </span>
                        </div>
                        <div class="detail-row edit-mode d-none">
                            <label class="form-label">Gênero</label>
                            <select name="genero" class="form-select">
                                <option value="" {% if not usuario.perfil.genero %}selected{% endif %}>Selecione...</option>
                                <option value="M" {% if usuario.perfil.genero == 'M' %}selected{% endif %}>Masculino</option>
                                <option value="F" {% if usuario.perfil.genero == 'F' %}selected{% endif %}>Feminino</option>
                                <option value="O" {% if usuario.perfil.genero == 'O' %}selected{% endif %}>Outro</option>
                            </select>
                        </div>

                        <div class="detail-row view-mode">
                            <span class="detail-label">Data de Nascimento:</span>
                            <span class="detail-value" id="dataNascimentoDisplay">
                                {% if usuario.perfil.data_nascimento %}
                                    {{ usuario.perfil.data_nascimento|date:"d/m/Y" }}
                                {% else %}
                                    Não informado
                                {% endif %}
                            </span>
                        </div>
                        <div class="detail-row edit-mode d-none">
                            <label class="form-label">Data de Nascimento</label>
                            <input type="date" name="data_nascimento" class="form-control" 
                                   value="{{ usuario.perfil.data_nascimento|date:'Y-m-d' }}">
                        </div>

                        <div class="detail-row view-mode">
                            <span class="detail-label">Telefone:</span>
                            <span class="detail-value" id="telefoneDisplay">
                                {% if usuario.perfil.telefone %}
                                    {{ usuario.perfil.telefone }}
                                    {% if usuario.perfil.telefone_whatsapp %}
                                        <span class="badge bg-success ms-2">WhatsApp</span>
                                    {% endif %}
                                {% else %}
                                    Não informado
                                {% endif %}
                            </span>
                        </div>
                        <div class="detail-row edit-mode d-none">
                            <div class="row">
                                <div class="col-8">
                                    <label class="form-label">Telefone</label>
                                    <input type="text" name="telefone" class="form-control" 
                                           value="{{ usuario.perfil.telefone }}" 
                                           placeholder="(00) 00000-0000">
                                </div>
                                <div class="col-4 d-flex align-items-end">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="telefone_whatsapp" 
                                               id="whatsappCheck" {% if usuario.perfil.telefone_whatsapp %}checked{% endif %}>
                                        <label class="form-check-label" for="whatsappCheck">WhatsApp</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Alteração</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p>⚠️ Deseja realmente alterar o papel deste usuário?</p>
                    <p class="mb-0"><strong>De:</strong> <span id="currentRoleText"></span></p>
                    <p><strong>Para:</strong> <span id="newRoleText"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="confirmChange" class="btn btn-primary">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
{{ block.super }}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- jQuery Mask -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Verifica se o jQuery está carregado
if (typeof jQuery == 'undefined') {
    console.error('Erro: jQuery não foi carregado corretamente!');
}

// Verifica se o Bootstrap está disponível
if (typeof bootstrap == 'undefined') {
    console.error('Erro: Bootstrap não foi carregado corretamente!');
}

// Variável para armazenar os dados originais
let originalData = {};

// Função para mostrar notificações
function showToast(type, title, message) {
    const toast = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}</strong><br>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    // Cria o container de toasts se não existir
    let $container = $('.toast-container');
    if ($container.length === 0) {
        $container = $('<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100"></div>');
        $('body').append($container);
    }
    
    // Adiciona o toast e mostra
    const $toast = $(toast);
    $container.append($toast);
    const bsToast = new bootstrap.Toast($toast[0]);
    bsToast.show();
    
    // Remove o toast quando for fechado
    $toast.on('hidden.bs.toast', function() {
        $toast.remove();
    });
}

// Inicialização quando o documento estiver pronto
$(document).ready(function() {
    console.log('Documento pronto - Iniciando configuração...');
    
    // Inicializa as máscaras
    $('.telefone-input').mask('(00) 00000-0000');
    $('.cep-input').mask('00000-000');
    
    console.log('Máscaras iniciais configuradas');
    
    // Configura o evento de clique no botão Editar Perfil
    $(document).on('click', '#btnEditarPerfil', function(e) {
        e.preventDefault();
        console.log('Botão Editar Perfil clicado');
        
        // Armazena os dados atuais para possível cancelamento
        originalData = {};
        $('input, select').each(function() {
            const $this = $(this);
            const name = $this.attr('name');
            if (name) {
                if ($this.is(':checkbox')) {
                    originalData[name] = $this.prop('checked');
                } else {
                    originalData[name] = $this.val();
                }
            }
        });
        
        console.log('Dados originais armazenados:', originalData);
        
        // Mostra os campos de edição e esconde a visualização
        $('.view-mode').addClass('d-none');
        $('.edit-mode').removeClass('d-none');
        $('#btnEditarPerfil').addClass('d-none');
        $('#btnSalvarPerfil, #btnCancelarEdicao').removeClass('d-none');
    });
    
    // Configura o evento de clique no botão Cancelar
    $(document).on('click', '#btnCancelarEdicao', function(e) {
        e.preventDefault();
        console.log('Botão Cancelar clicado');
        
        // Restaura os valores originais
        if (originalData) {
            for (const [name, value] of Object.entries(originalData)) {
                const $field = $(`[name="${name}"]`);
                if ($field.length) {
                    if ($field.is(':checkbox')) {
                        $field.prop('checked', value);
                    } else {
                        $field.val(value);
                    }
                }
            }
        }
        
        // Volta para o modo de visualização
        $('.view-mode').removeClass('d-none');
        $('.edit-mode').addClass('d-none');
        $('#btnEditarPerfil').removeClass('d-none');
        $('#btnSalvarPerfil, #btnCancelarEdicao').addClass('d-none');
    });
    
    // Configura o evento de clique no botão Salvar
    $(document).on('click', '#btnSalvarPerfil', function(e) {
        e.preventDefault();
        console.log('Botão Salvar clicado');
        
        const $btn = $(this);
        const $form = $('#basicInfoForm, #personalInfoForm');
        
        if (!$form.length) {
            console.error('Erro: Formulário não encontrado');
            showToast('danger', 'Erro', 'Formulário não encontrado');
            return;
        }
        
        // Desabilita o botão e mostra indicador de carregamento
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Salvando...');
        
        // Envia o formulário via AJAX
        $.ajax({
            url: $form.attr('action'),
            type: 'POST',
            data: $form.serialize(),
            success: function(response) {
                console.log('Resposta do servidor:', response);
                if (response.status === 'success') {
                    // Atualiza os campos na visualização
                    $('.view-mode .detail-value').each(function() {
                        const $this = $(this);
                        const field = $this.data('field');
                        if (field) {
                            const $input = $(`[name="${field}"]`);
                            if ($input.length) {
                                $this.text($input.val() || 'Não informado');
                            }
                        }
                    });
                    
                    showToast('success', 'Sucesso!', 'Perfil atualizado com sucesso!');
                    
                    // Volta para o modo de visualização
                    $('.view-mode').removeClass('d-none');
                    $('.edit-mode').addClass('d-none');
                    $('#btnEditarPerfil').removeClass('d-none');
                    $('#btnSalvarPerfil, #btnCancelarEdicao').addClass('d-none');
                } else {
                    throw new Error(response.message || 'Ocorreu um erro ao salvar as alterações.');
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro ao salvar:', status, error);
                let errorMsg = 'Ocorreu um erro ao processar sua solicitação.';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response && response.message) {
                        errorMsg = response.message;
                    }
                } catch (e) {
                    console.error('Erro ao processar resposta de erro:', e);
                }
                showToast('danger', 'Erro!', errorMsg);
            },
            complete: function() {
                $btn.prop('disabled', false).html('<i class="fas fa-save"></i> Salvar Alterações');
            }
        });
    });
    
    console.log('Configuração concluída com sucesso');
});
</script>

<style>
/* Estilos para os toasts */
.toast {
    min-width: 250px;
    margin-bottom: 1rem;
}

.toast-header {
    display: flex;
    justify-content: space-between;
}

.toast-body {
    padding: 0.75rem;
}
</style>
{% endblock %}
{% endblock %}
