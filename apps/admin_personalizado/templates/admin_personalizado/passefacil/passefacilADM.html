{% extends 'admin_personalizado/baseadmin.html' %}
{% load static %}

{% block title %}Passe Fácil - Painel de Administração{% endblock %}

{% block content %}
<!-- No cabeçalho do seu template passefacilADM.html, adicione: -->
{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
{% endblock %}
  <!-- CSS específico da página -->
  <link rel="stylesheet" href="{% static 'admin_personalizado/css/passefacilADM.css' %}">
  <link rel="stylesheet" href="{% static 'admin_personalizado/css/passefacilADM_updates.css' %}">

  <div class="passe-facil-container passefacil-admin">
    <!-- Cabeçalho (estilo do dashboard) -->
    <header class="main-header">
      <h2>Painel de Administração • Passe Fácil</h2>
      <div class="user-area">
        <div class="view-toggle">
          <button id="listViewBtn" class="view-btn active" data-view="list">
            <i class="fa-solid fa-list"></i>
            <span>Lista de Passes</span>
          </button>
          <button id="validateViewBtn" class="view-btn" data-view="validate">
            <i class="fa-solid fa-qrcode"></i>
            <span>Validar Passe</span>
          </button>
        </div>
      </div>
    </header>


    <!-- Conteúdo Principal -->
    <main class="passefacil-main">
      <!-- Resumo Estatístico -->
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="icon-chart-line"></i>
          </div>
          <div class="stat-info">
            <div class="card-header-row">
              <h3>{{ period_label|default:"Últimos 7 dias" }}</h3>
              <div class="charts-toolbar">
                <a href="?period=7d" class="btn btn-small{% if period == '7d' %} active{% endif %}"{% if period == '7d' %} aria-current="page"{% endif %}>7 dias</a>
                <a href="?period=30d" class="btn btn-small{% if period == '30d' %} active{% endif %}"{% if period == '30d' %} aria-current="page"{% endif %}>30 dias</a>
                <a href="?period=all" class="btn btn-small{% if period == 'all' %} active{% endif %}"{% if period == 'all' %} aria-current="page"{% endif %}>Desde sempre</a>
              </div>
            </div>
            <div class="mini-chart" id="miniChart"></div>
          </div>
        </div>
      </div>
      
      <!-- Tela de Listagem -->
      <section id="listView" class="view-content active">
        <div class="search-container">
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="Pesquisar por usuário ou código...">
            <i class="icon-search"></i>
          </div>
          <div class="results-count">
            <span id="totalResults">{{ passes|length }}</span> resultados encontrados
          </div>
        </div>

        <div class="table-container">
          <table id="passesTable">
            <thead>
              <tr>
                <th>Usuário</th>
                <th>Código</th>
                <th>Última Validação</th>
              </tr>
            </thead>
            <tbody id="passesTableBody">
              {% for passe in passes %}
              <tr>
                <td>
                  <div class="user-info">
                    <div class="user-avatar">
                      {% if passe.user.nome and passe.user.nome.strip %}
                          {{ passe.user.nome|first|upper }}
                      {% elif passe.user.email and passe.user.email.strip %}
                          {{ passe.user.email|first|upper }}
                      {% else %}
                          U
                      {% endif %}
                    </div>
                    <div class="user-details">
                      <span class="user-name">{{ passe.user.nome|default_if_none:''|default:passe.user.get_full_name|default:passe.user.username }}</span>
                      <span class="user-email">{{ passe.user.email }}</span>
                    </div>
                  </div>
                </td>
                <td class="code-cell">
                  <span class="code-value">{{ passe.codigo }}</span>
                  <button class="copy-btn" data-clipboard-text="{{ passe.codigo }}" title="Copiar código">
                    <i class="icon-copy"></i>
                  </button>
                </td>
                <td>
                  {% if passe.last_validacao_data %}
                    {{ passe.last_validacao_data|date:"d/m/Y H:i" }}
                    <span class="status-badge {% if passe.last_validacao_valido %}success{% else %}error{% endif %}">
                      {% if passe.last_validacao_valido %}Válido{% else %}Inválido{% endif %}
                    </span>
                  {% else %}
                    <span class="text-muted">Nunca validado</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="3" class="text-center">Nenhum passe encontrado</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- Tela de Validação -->
      <section id="validateView" class="view-content">
        <div class="validation-container">
          <!-- Abas de navegação -->
          <div class="tabs">
            <button class="tab-btn active" data-tab="qrTab">
              <i class="icon-qr"></i>
              Validar por QR Code
            </button>
            <button class="tab-btn" data-tab="manualTab">
              <i class="icon-keyboard"></i>
              Validar por Código
            </button>
          </div>

          <!-- Conteúdo das abas -->
          <div class="tab-content">
            <!-- Aba de QR Code -->
            <div id="qrTab" class="tab-pane active">
              <div class="camera-container">
                <div class="camera-placeholder" id="cameraFeed">
                  <div class="scanner-frame">
                    <div class="scanner-corner top-left"></div>
                    <div class="scanner-corner top-right"></div>
                    <div class="scanner-corner bottom-left"></div>
                    <div class="scanner-corner bottom-right"></div>
                  </div>
                  <p class="camera-hint">Posicione o QR Code dentro da área destacada</p>
                </div>
                <button id="toggleCameraBtn" class="btn btn-primary">
                  <i class="icon-camera"></i>
                  <span>Iniciar Câmera</span>
                </button>
              </div>
            </div>

            <!-- Aba de Código Manual -->
            <div id="manualTab" class="tab-pane">
              <div class="manual-validation">
                <div class="input-group">
                  <input type="text" id="manualCodeInput" placeholder="Digite o código do passe...">
                  <button id="validateManualBtn" class="btn btn-primary" disabled>
                    <i class="icon-check"></i>
                    Validar
                  </button>
                </div>
                <p class="input-hint">Digite o código completo do passe e clique em Validar</p>
              </div>
            </div>
          </div>

          <!-- Histórico de Validações -->
          <div class="validation-history">
            <div class="section-header">
              <h3>Últimas Validações</h3>
              <span class="badge" id="recentValidationsCount">{{ validacoes_recentes|length }}</span>
            </div>
            <div class="validations-list" id="validationsList">
              {% if validacoes_recentes %}
                {% for v in validacoes_recentes %}
                  <div class="validation-item">
                    <div class="validation-icon">
                      {% if v.valido %}
                        <i class="icon-check"></i>
                      {% else %}
                        <i class="icon-clock"></i>
                      {% endif %}
                    </div>
                    <div class="validation-details">
                      <h4>
                        {% if v.passe_facil and v.passe_facil.user %}
                          {{ v.passe_facil.user.nome|default_if_none:''|default:v.passe_facil.user.get_full_name|default:v.passe_facil.user.username }}
                        {% else %}
                          Código: {{ v.codigo }}
                        {% endif %}
                      </h4>
                      <div class="validation-meta">
                        <span class="validation-time">
                          <i class="icon-clock"></i>
                          {{ v.data_validacao|date:"d/m/Y H:i" }}
                        </span>
                        <span class="validation-status {% if v.valido %}status-success{% else %}status-error{% endif %}">
                          {% if v.valido %}Válido{% else %}Inválido{% endif %}
                        </span>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="empty-state">
                  <i class="icon-clock"></i>
                  <p>Nenhuma validação recente</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal de Detalhes -->
  <div id="validationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Validação Realizada</h3>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="validation-result success" id="validationResult">
          <div class="result-icon">
            <i class="icon-check-circle"></i>
          </div>
          <div class="result-details">
            <h4>Passe Válido</h4>
            <p>O passe foi validado com sucesso.</p>
          </div>
        </div>
        <div class="validation-info">
          <div class="info-row">
            <span class="info-label">Usuário:</span>
            <span class="info-value" id="modalUser">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Código:</span>
            <span class="info-value" id="modalCode">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Data/Hora:</span>
            <span class="info-value" id="modalDateTime">-</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="closeModalBtn">Fechar</button>
        <button class="btn btn-primary" id="newValidationBtn">
          <i class="icon-plus"></i>
          Nova Validação
        </button>
      </div>
    </div>
  </div>
  


  <!-- Dados para o gráfico -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    try {
      console.log('Iniciando inicialização do gráfico...');
      
      // Elemento container do gráfico
      const container = document.getElementById('miniChart');
      if (!container) {
        console.error('Elemento do gráfico não encontrado');
        return;
      }
      
      // Tenta obter os dados do template
      let labels, totais, validas, invalidas;
      
      try {
        labels = JSON.parse('{{ dias|safe|escapejs }}');
        totais = JSON.parse('{{ totais|safe|escapejs }}');
        validas = JSON.parse('{{ validas_list|safe|escapejs }}');
        invalidas = JSON.parse('{{ invalidas_list|safe|escapejs }}');
        
        console.log('Dados recebidos:', { labels, totais, validas, invalidas });
        
        if (!Array.isArray(labels) || !Array.isArray(totais) || 
            !Array.isArray(validas) || !Array.isArray(invalidas)) {
          throw new Error('Dados inválidos recebidos do servidor');
        }
      } catch (e) {
        console.error('Erro ao processar dados do gráfico:', e);
        container.innerHTML = '<div class="no-data">Erro ao carregar dados do gráfico</div>';
        return;
      }
      
      // Prepara os dados do gráfico
      const chartData = {
        labels: labels,
        datasets: [
          {
            label: 'Total de Validações',
            data: totais,
            borderColor: '#4e73df',
            backgroundColor: 'rgba(78, 115, 223, 0.05)',
            tension: 0.3,
            fill: true
          },
          {
            label: 'Válidas',
            data: validas,
            borderColor: '#1cc88a',
            borderDash: [5, 5],
            backgroundColor: 'transparent',
            tension: 0.3
          },
          {
            label: 'Inválidas',
            data: invalidas,
            borderColor: '#e74a3b',
            borderDash: [5, 5],
            backgroundColor: 'transparent',
            tension: 0.3
          }
        ]
      };
      
      console.log('Dados do gráfico preparados:', chartData);
      
      // Verifica se há dados para exibir
      if (!chartData.labels.length || !chartData.datasets.some(ds => ds.data && ds.data.length > 0)) {
        console.warn('Nenhum dado disponível para exibir no gráfico');
        container.innerHTML = '<div class="no-data">Nenhum dado disponível para o período selecionado</div>';
        return;
      }
      
      // Limpa o container e cria o canvas
      container.innerHTML = '<canvas></canvas>';
      const canvas = container.querySelector('canvas');
      
      if (!canvas) {
        throw new Error('Falha ao criar elemento canvas');
      }
      
      // Cria o gráfico
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        throw new Error('Não foi possível obter o contexto 2D do canvas');
      }
      
      console.log('Criando gráfico...');
      new Chart(ctx, {
        type: 'line',
        data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 20,
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                mode: 'index',
                intersect: false,
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleFont: { size: 14, weight: 'bold' },
                bodyFont: { size: 13 },
                padding: 12,
                displayColors: true,
                callbacks: {
                  label: function(context) {
                    return `${context.dataset.label}: ${context.raw}`;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              },
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0, 0, 0, 0.05)' },
                ticks: { stepSize: 1 }
              }
            },
            elements: {
              point: {
                radius: 0, // Remove os pontos da linha
                hoverRadius: 0, // Remove o hover dos pontos
                borderWidth: 0 // Remove a borda dos pontos
              },
              line: {
                tension: 0.4,
                borderWidth: 2,
                fill: false
              }
            }
          }
        });
      } catch (error) {
        console.error('Erro ao inicializar o gráfico:', error);
        const container = document.getElementById('miniChart');
        if (container) {
          container.innerHTML = '<div class="error-message">Erro ao carregar o gráfico. Por favor, recarregue a página.</div>';
        }
      }
    });
  </script>


  <!-- JavaScript da aplicação -->
  <script src="{% static 'admin_personalizado/js/passefacilADM.js' %}" defer></script>
{% endblock %}
